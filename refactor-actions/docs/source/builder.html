<!DOCTYPE html>

<html>
<head>
  <title>source/builder</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="http://strd6.github.io/cdn/parallel/docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    <ul class="sections">
        
        
        <li id="section-1">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="builder">Builder</h1>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>The builder knows how to compile a source tree or individual files into various
build products.</p>
<p>This should be extracted to a separate library eventually.</p>
<h2 id="dependencies">Dependencies</h2>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>This guy helps package our app and manage dependencies.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">Packager = require <span class="string">"packager"</span>
{readSourceConfig, arrayToHash} = require(<span class="string">'./util'</span>)</code></pre>
</div>
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="helpers">Helpers</h2>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><code>stripMarkdown</code> converts a literate file into pure code for compilation or execution.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">stripMarkdown</span></span> = (content) -&gt;
  content.split(<span class="string">"\n"</span>).map (line) -&gt;
    <span class="keyword">if</span> match = (<span class="regexp">/^([ ]{4}|\t)/</span>).exec line
      line[match[<span class="number">0</span>].length..]
    <span class="keyword">else</span>
      <span class="string">""</span>
  .join(<span class="string">"\n"</span>)</code></pre>
</div>
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><code>compileTemplate</code> compiles a haml file into a HAMLjr program.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">compileTemplate</span></span> = (source, name=<span class="string">"test"</span>) -&gt;
  program = HAMLjr.compile source,
    compiler: CoffeeScript

  <span class="string">"module.exports = <span class="subst">#{program}</span>;"</span></code></pre>
</div>
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><code>stringData</code> exports a string of text. When you require a file that exports
string data it returns the string for you to use in your code. This is handy for
CSS or other textually based data.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">stringData</span></span> = (source) -&gt;
  <span class="string">"module.exports = <span class="subst">#{JSON.stringify(source)}</span>;"</span></code></pre>
</div>
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><code>compileStyl</code> compiles a styl file into CSS and makes it available as a string
export.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">compileStyl</span></span> = (source) -&gt;
  styleContent = styl(source, whitespace: <span class="literal">true</span>).toString()

  stringData(styleContent)</code></pre>
</div>
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><code>compileCoffee</code> compiles a coffee file into JS and adds the sourceURL comment.</p>
<p>TODO: Work with the require component to make the sourceURL unique for files in
modules.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">compileCoffee</span></span> = (source, path) -&gt;
  <span class="string">"""
    <span class="subst">#{CoffeeScript.compile(source)}</span>
    //# sourceURL=<span class="subst">#{path}</span>
  """</span></code></pre>
</div>
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><code>compileFile</code> take a fileData and returns a buildData. A buildData has a <code>path</code>,
and properties for what type of content was built.</p>
<p>TODO: Allow for files to generate docs and code at the same time.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">compileFile</span></span> = ({path, content}) -&gt;
  [name, extension] = [path.withoutExtension(), path.extension()]

  result =
    <span class="keyword">switch</span> extension
      <span class="keyword">when</span> <span class="string">"js"</span>
        code: content
      <span class="keyword">when</span> <span class="string">"json"</span>
        code: stringData(JSON.parse(content))
      <span class="keyword">when</span> <span class="string">"cson"</span>
        code: stringData(CSON.parse(content))
      <span class="keyword">when</span> <span class="string">"coffee"</span>
        code: compileCoffee(content, path)
      <span class="keyword">when</span> <span class="string">"haml"</span>
        code: compileTemplate(content, name)
      <span class="keyword">when</span> <span class="string">"styl"</span>
        code: compileStyl(content)
      <span class="keyword">when</span> <span class="string">"css"</span>
        code: stringData(content)
      <span class="keyword">when</span> <span class="string">"md"</span>
        <span class="comment"># Separate out code and call compile again</span>
        compileFile
          path: name
          content: stripMarkdown(content)
      <span class="keyword">else</span>
        {}

  Object.defaults result,
    name: name
    extension: extension

  Object.extend result,
    path: path</code></pre>
</div>
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="builder">Builder</h2>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>The builder instance.</p>
<p>TODO: Extract this whole duder to a separate component.</p>
<p>TODO: Standardize interface to use promises.</p>
<p>TODO: Allow configuration of builder instances, adding additional compilers,
postprocessors, etc.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">Builder</span></span> = -&gt;
  <span class="function"><span class="title">build</span></span> = (fileData) -&gt;
    results = fileData.map ({path, content}) -&gt;
      <span class="keyword">try</span>
        <span class="comment"># TODO: Separate out tests</span>

        compileFile
          path: path
          content: content
      <span class="keyword">catch</span> {location, message}
        <span class="keyword">if</span> location?
          message = <span class="string">"Error on line <span class="subst">#{location.first_line + <span class="number">1</span>}</span>: <span class="subst">#{message}</span>"</span>

        error: <span class="string">"<span class="subst">#{path}</span> - <span class="subst">#{message}</span>"</span>

    [errors, data] = results.partition (result) -&gt; result.error

    <span class="keyword">if</span> errors.length
      Deferred().reject(errors.map (e) -&gt; e.error)
    <span class="keyword">else</span>
      Deferred().resolve(data)</code></pre>
</div>
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Post processors operate on the built package.</p>
<p>TODO: Maybe we should split post processors into the packager.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">  postProcessors = []

  addPostProcessor: (fn) -&gt;
    postProcessors.push fn</code></pre>
</div>
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Compile and build a tree of file data into a distribution. The distribution should
include source files, compiled files, and documentation.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">  build: (fileData, cache={}) -&gt;
    build(fileData)
    .<span class="keyword">then</span> (items) -&gt;
      results = []

      items.eachWithObject results, (item, hash) -&gt;
        <span class="keyword">if</span> item.code
          results.push item
        <span class="keyword">else</span>
          <span class="comment"># Do nothing, we don't know about this item</span>

      results = results.map (item) -&gt;
        path: item.name
        content: item.code
        type: <span class="string">"blob"</span>

      <span class="comment"># TODO: We should be able to put a lot of this into postProcessors</span>

      source = arrayToHash(fileData)

      config = readSourceConfig(source: source)

      <span class="comment"># TODO: Robustify bundled dependencies</span>
      <span class="comment"># Right now we're always loading them from remote urls during the</span>
      <span class="comment"># build step. The default http caching is probably fine to speed this</span>
      <span class="comment"># up, but we may want to look into keeping our own cache during dev</span>
      <span class="comment"># in addition to using the package's existing dependencies rather</span>
      <span class="comment"># than always updating</span>
      dependencies = config.dependencies <span class="keyword">or</span> {}

      Packager.collectDependencies(dependencies, cache)
      .<span class="keyword">then</span> (bundledDependencies) -&gt;
        postProcessors.pipeline
          version: config.version
          source: source
          distribution: arrayToHash(results)
          entryPoint: config.entryPoint <span class="keyword">or</span> <span class="string">"main"</span>
          dependencies: bundledDependencies
          remoteDependencies: config.remoteDependencies

module.exports = Builder</code></pre>
</div>
        </li>
        
    </ul>
  </div>
  <script src="../package.js"></script>,<script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/coffee-script/1.6.3/coffee-script.min.js"></script>
<script src="http://strd6.github.io/require/v0.2.2.js"></script>
<script src="http://strd6.github.io/interactive/v0.8.0.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
<script src="//d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js"></script>
<script src="http://strd6.github.io/tempest/javascripts/envweb.js"></script>
</body>
</html>